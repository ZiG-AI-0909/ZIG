// Get leads from previous node
const leads = $input.all();
const voiceCommand = $node["Telegram Trigger"].json.transcribedText || "";
const currentDate = new Date().toISOString();

// Transform each lead for Google Sheets
const formattedLeads = leads.map(lead => {
  const data = lead.json;
  
  return {
    json: {
      email: data.email || "",
      firstName: data.firstName || data.first_name || "",
      lastName: data.lastName || data.last_name || "",
      phone: data.phone || "",
      company: data.company || data.companyName || "",
      jobTitle: data.jobTitle || data.title || "",
      source: data.source || "Voice Bot Search",
      totalPurchases: data.totalPurchases || "0",
      lastPurchaseDate: data.lastPurchaseDate || "",
      lifetimeValue: data.lifetimeValue || "0",
      cartValue: data.cartValue || "0",
      productInterest: data.productInterest || "",
      websiteUrl: data.websiteUrl || data.website || "",
      linkedinUrl: data.linkedinUrl || data.linkedin || "",
      city: data.city || "",
      state: data.state || "",
      zipCode: data.zipCode || data.zip || "",
      country: data.country || "",
      leadType: data.leadType || "Cold",
      campaignName: `Voice Bot - ${currentDate.split('T')[0]}`,
      preferredContact: data.preferredContact || "Email",
      newsletterOptIn: data.newsletterOptIn || "No",
      smsOptIn: data.smsOptIn || "No",
      tags: Array.isArray(data.tags) ? data.tags.join(", ") : "",
      notes: `Generated via voice command: "${voiceCommand}"`,
      dateAdded: currentDate,
      voiceCommandUsed: voiceCommand
    }
  };
});

return formattedLeads;
